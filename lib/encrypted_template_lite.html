<div id="inner-encryted-page">
    <head>
        <script src="https://cdn.jsdelivr.net/npm/js-base64@3.6.0/base64.min.js"></script>
    </head>
    <style scoped>
         form {
            max-width: 330px;
            margin-top: 17%;

            --breakpoint-xs: 0;
            --breakpoint-sm: 576px;
            --breakpoint-md: 768px;
            --breakpoint-lg: 992px;
            --breakpoint-xl: 1200px;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            text-rendering: optimizeLegibility;
            line-height: 1.6em;
            color: #444;
            box-sizing: border-box;
            margin: 0;
            outline: 0;
            font-weight: inherit;
            font-style: inherit;
            font-family: inherit;
            font-size: 100%;
            vertical-align: baseline;
            max-width: 330px;
            margin-top: 17%;
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            word-wrap: break-word;
            background-color: #fff;
            background-clip: border-box;
            border: 1px solid rgba(0, 0, 0, .125);
            border-radius: .25rem;
            width: 100% !important;
            padding: 1.5rem !important;
            margin-right: auto !important;
            margin-left: auto !important;
            text-align: left !important;
        }

        h1 {
            --breakpoint-xs: 0;
            --breakpoint-sm: 576px;
            --breakpoint-md: 768px;
            --breakpoint-lg: 992px;
            --breakpoint-xl: 1200px;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            text-rendering: optimizeLegibility;
            color: #444;
            word-wrap: break-word;
            box-sizing: border-box;
            padding: 0;
            border: 0;
            outline: 0;
            font-style: inherit;
            font-family: inherit;
            vertical-align: baseline;
            margin-bottom: 1rem !important;
            text-align: center !important;
            font-size: 2em;
            line-height: 1em;
            font-weight: bold;
            margin: 1em 0;
        }

        input {
            --breakpoint-xs: 0;
            --breakpoint-sm: 576px;
            --breakpoint-md: 768px;
            --breakpoint-lg: 992px;
            --breakpoint-xl: 1200px;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            word-wrap: break-word;
            box-sizing: border-box;
            margin: 0;
            font-family: inherit;
            overflow: visible;
            display: block;
            width: 100%;
            height: calc(1.5em + .75rem + 2px);
            padding: .375rem .75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
            border-top-right-radius: .25rem !important;
            border-bottom-right-radius: .25rem !important;
        }

        button {
            --breakpoint-xs: 0;
            --breakpoint-sm: 576px;
            --breakpoint-md: 768px;
            --breakpoint-lg: 992px;
            --breakpoint-xl: 1200px;
            --font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            --font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            word-wrap: break-word;
            box-sizing: border-box;
            margin: 0;
            font-family: inherit;
            overflow: visible;
            text-transform: none;
            font-weight: 400;
            text-align: center;
            user-select: none;
            border: 1px solid transparent;
            transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
            padding: .5rem 1rem;
            font-size: 1.25rem;
            line-height: 1.5;
            border-radius: .3rem;
            display: block;
            width: 100%;
            margin-top: 1rem !important;
            cursor: pointer;
        } 
    </style>

    <div class="text-center h-100">
        <form class="text-left mx-auto card p-4 w-100 p-2" autocomplete="off" target="hide_iframe">
            <h1 class="h3 mb-3 text-center">请输入访问密码</h1>  <input type="password"
                id="password" name="current-password" autocomplete="current-password"
                class="form-control rounded-right input-password" spellcheck="false" autocorrect="off"
                autocapitalize="off" required=""> <button class="btn btn-lg btn-primary btn-block mt-3"
                onclick="checkPassword()"> 验证 </button>
            <div id="encoded_text" style="display:none;">
                base64_text
            </div>
            <iframe id="id_iframe" name="hide_iframe" style="display:none;"></iframe>
    </div>

    <script type="text/javascript">
        var Base64WithXOR = {
            encode: function (input) {
                return Base64.encode(input);
            },

            decode: function (input) {
                return Base64.decode(input);
            },

            encode_with_xor: function (input, key) {
                var pwd = this.encode(key);
                var xor_string = this._xor_handle(input, pwd);
                return this.encode(xor_string);
            },

            decode_with_xor: function (input, key) {
                var pwd = this.encode(key);
                var decode_string = this.decode(input);
                return this._xor_handle(decode_string, pwd);
            },

            _xor_handle: function (source, key) {
                var result = "";
                for (var i = 0; i < source.length; i++) {
                    var source_char = source.charCodeAt(i);
                    var key_idx = i % key.length;
                    var xor_char_code = key.charCodeAt(key_idx) ^ source_char;
                    result += String.fromCharCode(xor_char_code);
                }
                return result;
            },
        }

        var CachePassword = {
            cache: window.localStorage,
            page_key: 'hexo-encrypted-package-html:#' + window.location.pathname,
            get: function() {
               var old_password = this.cache.getItem(this.page_key); 
               if(old_password) {
                   return old_password;
               }
               return "";
            },

            set: function(new_password) {
                this.cache.setItem(this.page_key, new_password);
            },
        }

        // 自动密码验证
        function autoCheckPassword() {
            var old_pwd = CachePassword.get();
            var handle_fun = function(page_html, decoded_ele) {
                page_html.outerHTML = decoded_ele;
            };
            checkPasswordWrapper(old_pwd, handle_fun, null);
        }

        // 手动密码验证
        function checkPassword() {
            var pwd = document.getElementById("password").value;
            var handle_fun = function(page_html, decoded_ele) {
                page_html.outerHTML = decoded_ele;
                CachePassword.set(pwd);
            };
            var error_fun = function() {
                alert("密码错误，请重新输入");
            };

            checkPasswordWrapper(pwd, handle_fun, error_fun);
        }

        function checkPasswordWrapper(pwd, handle_fun, error_fun) {
            var encoded_content = document.getElementById("encoded_text").innerHTML;
            var decoded_ele = Base64WithXOR.decode_with_xor(encoded_content, pwd);
            var full_decoded_text = decoded_ele.trim();
            var prefix = "hexo-encrypted-package-html";
            var decoded_text = full_decoded_text.substr(prefix.length);
            if (decoded_text.length == 0 || full_decoded_text.startsWith(prefix)) {
                if (typeof handle_fun === "function") {
                    handle_fun(document.getElementById("inner-encryted-page"), decoded_text);
                }
                return true;
            } else {
                if (typeof error_fun === "function") {
                    error_fun();
                }
                return false;
            }
        }

        autoCheckPassword();
    </script>

</div>